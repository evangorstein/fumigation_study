---
title: "Network Analysis"
author: "Tianyi Xu"
date: "2023-06-22"
output: html_document
---

```{r}
#installation in case you need some package
#install.packages(c("igraph", "graphlayouts", "ggraph","ggforce"))
#devtools::install_github("schochastics/networkdata")
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(vegan)
library(tidyverse)
library(here)
library(forcats)
library(compositions)
library(dplyr)
library(stringr)
library(glasso)
library(igraph)
library(qgraph)
library(ggraph)
library(networkdata)
library(graphlayouts)
library(ggforce)
```

Read in the data

```{r}
samp_metadata = readRDS(here("data", "clean", "samp_metadata.RDS"))
bac_abundance = readRDS(here("data", "clean", "bac_abundance.RDS"))
```

Data Preprocessing
    
```{r}
# Aggregate based on families. Choose to look at family OTU.
fam.df = bac_abundance %>% 
  mutate(Family = fct_na_value_to_level(Family, "Unknown_Family")) %>% #Missing values included in Unknown_Family level
  group_by(Family) %>%
  summarise(across(starts_with("Samp"), sum)) 

fams = fam.df$Family
fam.mat = as.matrix(fam.df[,-1])
rownames(fam.mat) = fams
fam.mat = fam.mat[rownames(fam.mat)!="Unknown_Family",]
fam.mat = t(fam.mat)

# add sample number to metadata for each samples.
samp_metadata = samp_metadata %>%
  mutate(fumigation = case_when(
    Time == "Day_0" | Treatment == "Non-fumigated chipping grass"  ~ "never",
    Time == "Day_10" & Treatment != "Non-fumigated chipping grass" ~ "recent",
    Time != "Day_0" & Time != "Day_10" & Treatment != "Non-fumigated chipping grass" ~ "past"
  )) %>%
  mutate(sample_name = case_when(
    samp_number < 10 ~ paste0("Samp00", samp_number),
    samp_number < 100 ~ paste0("Samp0", samp_number),
    TRUE ~ paste0("Samp", samp_number)
  ))

# pull out samples based on fumigation time
never = samp_metadata %>% filter(fumigation == "never") %>% pull(sample_name)
recent = samp_metadata %>% filter(fumigation == "recent") %>% pull(sample_name)
past = samp_metadata %>% filter(fumigation == "past") %>% pull(sample_name)

# create 3 different matrix for 3 fumigation time
fam.mat.never = fam.mat[never,]
fam.mat.recent = fam.mat[recent,]
fam.mat.past = fam.mat[past,]
```

Function for data analysis

```{r}
# create a function to process matrix
create_matrix = function(mat){
    # clr transformation
    mat = mat + 0.5
    mat = clr(mat)

    # correlation matrix
    mat = cor(mat)
    return(mat)
}

glasso_net = function(mat, rho){
    net = glasso(mat, rho = rho)
    p.net = net$wi
    colnames(p.net) = colnames(mat)
    rownames(p.net) = rownames(mat)

    # check if matrix is symmetric
    if (!isSymmetric(p.net)) {
        p.net[lower.tri(p.net)] = t(p.net)[lower.tri(p.net)]
    }

    # calculate partical correlation matrix
    parr.corr.net = matrix(nrow = nrow(p.net), ncol = ncol(p.net))

    for(k in 1:nrow(parr.corr.net)) {
        for(j in 1:ncol(parr.corr.net)) {
        parr.corr.net[j, k] = -p.net[j,k]/sqrt(p.net[j,j]*p.net[k,k])
        }
    }

    colnames(parr.corr.net) = colnames(p.net)
    rownames(parr.corr.net) = rownames(p.net)
    diag(parr.corr.net) = 0

    net.glasso = graph.adjacency(parr.corr.net, mode = "undirected", weighted = TRUE, diag = FALSE)
    return(net.glasso)
}

# function for dissimilarity matrix
dis_net = function(mat, cutoff){
    diss.mat = as.matrix(vegdist(t(mat)), method = "bray")
    diss.adj = ifelse(diss.mat <= cutoff, 1, 0)
    net.diss = graph.adjacency(diss.adj, mode = "undirected", diag = FALSE)
    return(net.diss)
}

# function for correlation matrix method
corr_net = function(mat, cutoff){
    mat = mat + 0.5
    mat = clr(mat)
    cor.mat = cor(mat, method = "pearson")
    corr.adj = ifelse(abs(cor.mat) >= cutoff, 1, 0)
    net.corr = graph.adjacency(corr.adj, mode = "undirected", diag = FALSE)
    return(net.corr)
}
```

Plot the network - Glasso

```{r}
# first get transformed matrix
never.mat = create_matrix(fam.mat.never)
recent.mat = create_matrix(fam.mat.recent)
past.mat = create_matrix(fam.mat.past)

never.glasso = glasso_net(never.mat, 0.75)
recent.glasso = glasso_net(recent.mat, 0.75)
past.glasso = glasso_net(past.mat, 0.75)

# convert glasso weight to positive
E(never.glasso)$weight = E(never.glasso)$weight - (min(E(never.glasso)$weight)) + 0.0001
E(recent.glasso)$weight = E(recent.glasso)$weight - (min(E(recent.glasso)$weight)) + 0.0001
E(past.glasso)$weight = E(past.glasso)$weight - (min(E(past.glasso)$weight)) + 0.0001

# compute clustering
V(never.glasso)$clu = as.character(membership(cluster_louvain(never.glasso)))
V(recent.glasso)$clu = as.character(membership(cluster_louvain(recent.glasso)))
V(past.glasso)$clu = as.character(membership(cluster_louvain(past.glasso)))

# compute node size based on degree
V(never.glasso)$size = degree(never.glasso)
V(recent.glasso)$size = degree(recent.glasso)
V(past.glasso)$size = degree(past.glasso)

V(never.glasso)$clu[V(never.glasso)$degree == 0] = "999"
V(recent.glasso)$clu[V(recent.glasso)$degree == 0] = "999"
V(past.glasso)$clu[V(past.glasso)$degree == 0] = "999"

# Find nodes with a degree of 0 for each graph
zero_degree_nodes_never <- V(never.glasso)[degree(never.glasso) == 0]
zero_degree_nodes_recent <- V(recent.glasso)[degree(recent.glasso) == 0]
zero_degree_nodes_past <- V(past.glasso)[degree(past.glasso) == 0]

# Assign these nodes to a new community cluster (e.g., cluster "new_cluster")
V(never.glasso)[degree(never.glasso) == 0]$clu <- "999"
V(recent.glasso)[degree(recent.glasso) == 0]$clu <- "999"
V(past.glasso)[degree(past.glasso) == 0]$clu <- "999"
```

Plot the network for Glasso method

```{r}
# plot the network for glasso
ggraph(never.glasso, layout = "fr") +
  geom_edge_link0(color = "grey66") +
  geom_node_point(aes(fill = clu, size = size), shape = 21) +
  geom_node_text(aes(filter = size > 99, label = name), family = "serif") +
  scale_edge_width(range = c(0.2, 3)) +
  scale_size(range = c(1, 6))

# find out largest cluster in glasso and create subgraph
mem.never.glasso = membership(cluster_louvain(never.glasso))
cluster.never.glasso = table(mem.never.glasso)
largest_cluster.never.glasso = names(cluster.never.glasso)[which.max(cluster.never.glasso)]
subvertice.never.glasso = which(mem.never.glasso == largest_cluster.never.glasso)

subgraph.never.glasso = induced_subgraph(never.glasso, subvertice.never.glasso)
ggraph(subgraph.never.glasso, layout = "nicely") +
  geom_edge_link0(color = "grey66") +
  geom_node_point(aes(fill = clu, size = size), shape = 21) +
  geom_node_text(aes(filter = size > 1, label = name), family = "serif", repel = TRUE) +
  scale_edge_width(range = c(0.2, 3)) +
  scale_size(range = c(1, 6))

# recent
ggraph(recent.glasso, layout = "fr") +
  geom_edge_link0(color = "grey66") +
  geom_node_point(aes(fill = clu, size = size), shape = 21) +
  geom_node_text(aes(filter = size > 99, label = name), family = "serif") +
  scale_edge_width(range = c(0.2, 3)) +
  scale_size(range = c(1, 6))

mem.recent.glasso = membership(cluster_louvain(recent.glasso))
cluster.recent.glasso = table(mem.recent.glasso)
largest_cluster.recent.glasso = names(cluster.recent.glasso)[which.max(cluster.recent.glasso)]
subvertice.recent.glasso = which(mem.recent.glasso == largest_cluster.recent.glasso)

subgraph.recent.glasso = induced_subgraph(recent.glasso, subvertice.recent.glasso)
ggraph(subgraph.recent.glasso, layout = "nicely") +
  geom_edge_link0(color = "grey66") +
  geom_node_point(aes(fill = clu, size = size), shape = 21) +
  geom_node_text(aes(filter = size > 1, label = name), family = "serif", repel = TRUE) +
  scale_edge_width(range = c(0.2, 3)) +
  scale_size(range = c(1, 6))

# past
ggraph(past.glasso, layout = "fr") +
  geom_edge_link0(color = "grey66") +
  geom_node_point(aes(fill = clu, size = size), shape = 21) +
  geom_node_text(aes(filter = size > 99, label = name), family = "serif") +
  scale_edge_width(range = c(0.2, 3)) +
  scale_size(range = c(1, 6))

mem.past.glasso = membership(cluster_louvain(past.glasso))
cluster.past.glasso = table(mem.past.glasso)
largest_cluster.past.glasso = names(cluster.past.glasso)[which.max(cluster.past.glasso)]
subvertice.past.glasso = which(mem.past.glasso == largest_cluster.past.glasso)

subgraph.past.glasso = induced_subgraph(past.glasso, subvertice.past.glasso)
ggraph(subgraph.past.glasso, layout = "nicely") +
  geom_edge_link0(color = "grey66") +
  geom_node_point(aes(fill = clu, size = size), shape = 21) +
  geom_node_text(aes(filter = size > 1, label = name), family = "serif", repel = TRUE) +
  scale_edge_width(range = c(0.2, 3)) +
  scale_size(range = c(1, 6))
```


Plot the dissimilarity network

```{r}
never.diss = dis_net(fam.mat.never, 0.5)
recent.diss = dis_net(fam.mat.recent, 0.5)
past.diss = dis_net(fam.mat.past, 0.5)

#compute clustering
V(never.diss)$clu = as.character(membership(cluster_louvain(never.diss)))
V(recent.diss)$clu = as.character(membership(cluster_louvain(recent.diss)))
V(past.diss)$clu = as.character(membership(cluster_louvain(past.diss)))

# compute node size based on degree
V(never.diss)$size = degree(never.diss)
V(recent.diss)$size = degree(recent.diss)
V(past.diss)$size = degree(past.diss)

V(never.diss)[degree(never.diss) == 0]$clu <- "999"
V(recent.diss)[degree(recent.diss) == 0]$clu <- "999"
V(past.diss)[degree(past.diss) == 0]$clu <- "999"
```

```{r}
# plot the network for dissimilarity

# never
ggraph(never.diss, layout = "fr") +
  geom_edge_link0(color = "grey66") +
  geom_node_point(aes(fill = clu, size = size), shape = 21) +
  geom_node_text(aes(filter = size > 99, label = name), family = "serif") +
  scale_edge_width(range = c(0.2, 3)) +
  scale_size(range = c(1, 6))

mem.never.diss = membership(cluster_louvain(never.diss))
cluster.never.diss = table(mem.never.diss)
largest_cluster.never.diss = names(cluster.never.diss)[which.max(cluster.never.diss)]
subvertice.never.diss = which(mem.never.diss == largest_cluster.never.diss)

subgraph.never.diss = induced_subgraph(never.diss, subvertice.never.diss)
ggraph(subgraph.never.diss, layout = "nicely") +
  geom_edge_link0(color = "grey66") +
  geom_node_point(aes(fill = clu, size = size), shape = 21) +
  geom_node_text(aes(filter = size > 1, label = name), family = "serif", repel = TRUE) +
  scale_edge_width(range = c(0.2, 3)) +
  scale_size(range = c(1, 6))

# recnt
ggraph(recent.diss, layout = "fr") +
  geom_edge_link0(color = "grey66") +
  geom_node_point(aes(fill = clu, size = size), shape = 21) +
  geom_node_text(aes(filter = size > 99, label = name), family = "serif") +
  scale_edge_width(range = c(0.2, 3)) +
  scale_size(range = c(1, 6))

mem.recent.diss = membership(cluster_louvain(recent.diss))
cluster.recent.diss = table(mem.recent.diss)
largest_cluster.recent.diss = names(cluster.recent.diss)[which.max(cluster.recent.diss)]
subvertice.recent.diss = which(mem.recent.diss == largest_cluster.recent.diss)

subgraph.recent.diss = induced_subgraph(recent.diss, subvertice.recent.diss)
ggraph(subgraph.recent.diss, layout = "nicely") +
  geom_edge_link0(color = "grey66") +
  geom_node_point(aes(fill = clu, size = size), shape = 21) +
  geom_node_text(aes(filter = size > 1, label = name), family = "serif", repel = TRUE) +
  scale_edge_width(range = c(0.2, 3)) +
  scale_size(range = c(1, 6))

# past
ggraph(past.diss, layout = "fr") +
  geom_edge_link0(color = "grey66") +
  geom_node_point(aes(fill = clu, size = size), shape = 21) +
  geom_node_text(aes(filter = size > 99, label = name), family = "serif") +
  scale_edge_width(range = c(0.2, 3)) +
  scale_size(range = c(1, 6))

mem.past.diss = membership(cluster_louvain(past.diss))
cluster.past.diss = table(mem.past.diss)
largest_cluster.past.diss = names(cluster.past.diss)[which.max(cluster.past.diss)]
subvertice.past.diss = which(mem.past.diss == largest_cluster.past.diss)

subgraph.past.diss = induced_subgraph(past.diss, subvertice.past.diss)
ggraph(subgraph.past.diss, layout = "nicely") +
  geom_edge_link0(color = "grey66") +
  geom_node_point(aes(fill = clu, size = size), shape = 21) +
  geom_node_text(aes(filter = size > 1, label = name), family = "serif", repel = TRUE) +
  scale_edge_width(range = c(0.2, 3)) +
  scale_size(range = c(1, 6))
```

Plot the network - correlation

```{r}
never.corr = corr_net(fam.mat.never, 0.75)
recent.corr = corr_net(fam.mat.recent, 0.75)
past.corr = corr_net(fam.mat.past, 0.75)

# compute clustering
V(never.corr)$clu = as.character(membership(cluster_louvain(never.corr)))
V(recent.corr)$clu = as.character(membership(cluster_louvain(recent.corr)))
V(past.corr)$clu = as.character(membership(cluster_louvain(past.corr)))

# compute node size based on degree
V(never.corr)$size = degree(never.corr)
V(recent.corr)$size = degree(recent.corr)
V(past.corr)$size = degree(past.corr)

V(never.corr)[degree(never.corr) == 0]$clu <- "999"
V(recent.corr)[degree(recent.corr) == 0]$clu <- "999"
V(past.corr)[degree(past.corr) == 0]$clu <- "999"
```

```{r}
#Plot the network for correlation

#never
ggraph(never.corr, layout = "fr") +
  geom_edge_link0(color = "grey66") +
  geom_node_point(aes(fill = clu, size = size), shape = 21) +
  geom_node_text(aes(filter = size > 99, label = name), family = "serif") +
  scale_edge_width(range = c(0.2, 3)) +
  scale_size(range = c(1, 6))

mem.never.corr = membership(cluster_louvain(never.corr))
cluster.never.corr = table(mem.never.corr)
largest_cluster.never.corr = names(cluster.never.corr)[which.max(cluster.never.corr)]
subvertice.never.corr = which(mem.never.corr == largest_cluster.never.corr)

subgraph.never.corr = induced_subgraph(never.corr, subvertice.never.corr)
ggraph(subgraph.never.corr, layout = "nicely") +
  geom_edge_link0(color = "grey66") +
  geom_node_point(aes(fill = clu, size = size), shape = 21) +
  geom_node_text(aes(filter = size > 1, label = name), family = "serif", repel = TRUE) +
  scale_edge_width(range = c(0.2, 3)) +
  scale_size(range = c(1, 6))

# recent
ggraph(recent.corr, layout = "fr") +
  geom_edge_link0(color = "grey66") +
  geom_node_point(aes(fill = clu, size = size), shape = 21) +
  geom_node_text(aes(filter = size > 99, label = name), family = "serif") +
  scale_edge_width(range = c(0.2, 3)) +
  scale_size(range = c(1, 6))

mem.recent.corr = membership(cluster_louvain(recent.corr))
cluster.recent.corr = table(mem.recent.corr)
largest_cluster.recent.corr = names(cluster.recent.corr)[which.max(cluster.recent.corr)]
subvertice.recent.corr = which(mem.recent.corr == largest_cluster.recent.corr)

subgraph.recent.corr = induced_subgraph(recent.corr, subvertice.recent.corr)
ggraph(subgraph.recent.corr, layout = "nicely") +
  geom_edge_link0(color = "grey66") +
  geom_node_point(aes(fill = clu, size = size), shape = 21) +
  geom_node_text(aes(filter = size > 1, label = name), family = "serif", repel = TRUE) +
  scale_edge_width(range = c(0.2, 3)) +
  scale_size(range = c(1, 6))

#past

ggraph(past.corr, layout = "fr") +
  geom_edge_link0(color = "grey66") +
  geom_node_point(aes(fill = clu, size = size), shape = 21) +
  geom_node_text(aes(filter = size > 99, label = name), family = "serif") +
  scale_edge_width(range = c(0.2, 3)) +
  scale_size(range = c(1, 6))

mem.past.corr = membership(cluster_louvain(past.corr))
cluster.past.corr = table(mem.past.corr)
largest_cluster.past.corr = names(cluster.past.corr)[which.max(cluster.past.corr)]
subvertice.past.corr = which(mem.past.corr == largest_cluster.past.corr)

subgraph.past.corr = induced_subgraph(past.corr, subvertice.past.corr)
ggraph(subgraph.past.corr, layout = "nicely") +
  geom_edge_link0(color = "grey66") +
  geom_node_point(aes(fill = clu, size = size), shape = 21) +
  geom_node_text(aes(filter = size > 1, label = name), family = "serif", repel = TRUE) +
  scale_edge_width(range = c(0.2, 3)) +
  scale_size(range = c(1, 6))
```


